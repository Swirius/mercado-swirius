<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Inicio</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}">
</head>
<body>
    <!-- Navbar correctamente insertado -->
    <div th:replace="~{fragmentos/nav :: navbar}"></div>

    <div class="container">
        <div th:if="${#authorization.expression('isAuthenticated()')}">
            <p>Bienvenido, <strong th:text="${#authentication.name}">Usuario</strong></p>
        </div>

        <!-- 🧠 Buscador -->
        <form th:action="@{/}" method="get">
            <input type="text" name="q" th:value="${q}" placeholder="Buscar por nombre..." />
            <select name="cat">
                <option value="">Todas</option>
                <option th:selected="${cat == 'Tecnología'}" value="Tecnología">Tecnología</option>
                <option th:selected="${cat == 'Hogar'}" value="Hogar">Hogar</option>
                <option th:selected="${cat == 'Moda'}" value="Moda">Moda</option>
                <option th:selected="${cat == 'Deportes'}" value="Deportes">Deportes</option>
                <option th:selected="${cat == 'Otros'}" value="Otros">Otros</option>
            </select>
            <input type="number" name="min" th:value="${min}" step="0.01" placeholder="Precio mínimo" />
            <input type="number" name="max" th:value="${max}" step="0.01" placeholder="Precio máximo" />
            <button type="submit">🔍 Buscar</button>
        </form>

        <h2>Productos</h2>

        <div th:if="${productos != null and !productos.isEmpty()}">
            <div th:each="prod : ${productos}">
                <h3>
                    <a th:href="@{'/productos/detalle/' + ${prod.id}}" th:text="${prod.nombre}">Nombre</a>
                </h3>

                <div th:if="${prod.imagen != null}">
                    <img th:src="@{'/uploads/' + ${prod.imagen}}" width="200" alt="Imagen de producto" />
                </div>

                <p th:text="${prod.descripcion}">Descripción</p>
                <p><strong>$</strong><span th:text="${prod.precio}"></span></p>
                <p><strong>Stock:</strong> <span th:text="${prod.stock}"></span></p>
                <p><strong>Categoría:</strong> <span th:text="${prod.categoria}"></span></p>

                <!-- 🔒 Admin: Editar/Eliminar -->
                <th:block th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
                    <a th:href="@{'/productos/editar/' + ${prod.id}}">✏️ Editar</a> |
                    <a th:href="@{'/productos/eliminar/' + ${prod.id}}"
                       onclick="return confirm('¿Seguro que querés eliminar este producto?')">🗑️ Eliminar</a>
                </th:block>

                <!-- 👤 Usuarios autenticados -->
                <div th:if="${#authorization.expression('isAuthenticated()')}">
                    <div th:if="${prod.stock > 0}">
                        <form th:action="@{'/carrito/agregar/' + ${prod.id}}" method="post">
                            <label for="cantidad">Cantidad:</label>
                            <input type="number" id="cantidad" name="cantidad" min="1"
                                   th:attr="max=${prod.stock}" value="1" required />
                            <button type="submit">🛒 Agregar al carrito</button>
                        </form>
                    </div>
                    <div th:if="${prod.stock == 0}">
                        <p style="color: red;">❌ Sin stock disponible</p>
                    </div>
                </div>

                <hr />
            </div>

            <!-- 📄 Paginación -->
            <div th:if="${totalPages > 1}">
                <div class="paginacion">
                    <a th:if="${currentPage > 0}"
                       th:href="@{/?page=${currentPage - 1}(q=${q}, cat=${cat}, min=${min}, max=${max})}">« Anterior</a>
                    <span>Página <span th:text="${currentPage + 1}"></span> de <span th:text="${totalPages}"></span></span>
                    <a th:if="${currentPage + 1 < totalPages}"
                       th:href="@{/?page=${currentPage + 1}(q=${q}, cat=${cat}, min=${min}, max=${max})}">Siguiente »</a>
                </div>
            </div>
        </div>

        <div th:if="${productos == null or productos.isEmpty()}">
            <p style="color: gray;">🔍 No se encontraron productos con ese criterio.</p>
        </div>
    </div>
</body>
</html>
