<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Inicio</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}">
</head>
<body>
    <header>
        <h1>Mercado Swirius</h1>
        <nav>
            <a th:href="@{/}">Inicio</a>
            <a th:if="${#authorization.expression('isAuthenticated()')}" th:href="@{/carrito}">🛒 Ver Carrito</a>
            <a th:if="${#authorization.expression('isAuthenticated()')}" th:href="@{/logout}">Logout</a>
            <a th:unless="${#authorization.expression('isAuthenticated()')}" th:href="@{/login}">Login</a>
            <a th:unless="${#authorization.expression('isAuthenticated()')}" th:href="@{/registro}">Registro</a>
        </nav>
    </header>

    <div class="container">
        <div th:if="${#authorization.expression('isAuthenticated()')}">
            <p>
                Bienvenido, <strong th:text="${#authentication.principal.nombre}">Usuario</strong>
                | Rol: <strong th:text="${#authentication.principal.rol}">Rol</strong>
            </p>

            <a th:if="${#authentication.principal.rol == 'ADMIN'}" th:href="@{/productos/nuevo}">➕ Nuevo Producto</a>
        </div>

        <!-- 🧠 Buscador -->
        <form th:action="@{/}" method="get">
    		<input type="text" name="q" th:value="${q}" placeholder="Buscar por nombre..." />

   			<input type="text" name="cat" th:value="${cat}" placeholder="Categoría" />

    		<input type="number" name="min" th:value="${min}" step="0.01" placeholder="Precio mínimo" />
   			<input type="number" name="max" th:value="${max}" step="0.01" placeholder="Precio máximo" />

    		<button type="submit">🔍 Buscar</button>
		</form>


        <h2>Productos</h2>

        <div th:if="${productos != null and !productos.isEmpty()}">
            <div th:each="prod : ${productos}">
                <h3>
                    <a th:href="@{'/productos/detalle/' + ${prod.id}}" th:text="${prod.nombre}">Nombre</a>
                </h3>

                <div th:if="${prod.imagen != null}">
                    <img th:src="@{'/uploads/' + ${prod.imagen}}" width="200" alt="Imagen de producto" />
                </div>

                <p th:text="${prod.descripcion}">Descripción</p>
                <p><strong>$</strong><span th:text="${prod.precio}">Precio</span></p>
                <p><strong>Categoría:</strong> <span th:text="${prod.categoria}"></span></p>
                

                <div th:if="${#authentication.principal.rol == 'ADMIN'}">
                    <a th:href="@{'/productos/editar/' + ${prod.id}}">✏️ Editar</a> |
                    <a th:href="@{'/productos/eliminar/' + ${prod.id}}"
                       onclick="return confirm('¿Seguro que querés eliminar este producto?')">🗑️ Eliminar</a>
                </div>

                <div th:if="${#authorization.expression('isAuthenticated()')}">
                    <div th:if="${prod.stock > 0}">
                        <a th:href="@{'/carrito/agregar/' + ${prod.id}}">🛒 Agregar al carrito</a>
                    </div>
                    <div th:if="${prod.stock == 0}">
                        <p style="color: red;">❌ Sin stock</p>
                    </div>
                </div>
                <hr />
            </div>
        </div>

        <div th:if="${productos == null or productos.isEmpty()}">
            <p style="color: gray;">🔍 No se encontraron productos con ese criterio.</p>
        </div>

        <div th:if="${#authorization.expression('isAuthenticated()')}">
            <a th:href="@{/historial}">📜 Mis Compras</a>
        </div>
    </div>
</body>
</html>
